<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️ Admin - รพ.ราชวิถี</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        * { font-family: 'Sarabun', sans-serif; }
        :root { --pink: #e91e8c; --pink-light: #fce4f1; }
        body { background: #f5f5f5; padding: 20px; }
        .header { background: linear-gradient(135deg, var(--pink), #c4177a); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 2px solid #eee; font-weight: 600; padding: 15px 20px; border-radius: 15px 15px 0 0 !important; }
        .card-body { padding: 20px; }
        .stat-card { text-align: center; padding: 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; }
        .stat-value { font-size: 36px; font-weight: 700; }
        .stat-label { opacity: 0.9; }
        .btn-pink { background: var(--pink); border-color: var(--pink); color: white; }
        .btn-pink:hover { background: #c4177a; color: white; }
        .menu-item { display: flex; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; text-decoration: none; color: inherit; }
        .menu-item:hover { border-color: var(--pink); background: var(--pink-light); transform: translateX(5px); }
        .menu-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-online { background: #d4edda; color: #155724; }
        .status-offline { background: #f8d7da; color: #721c24; }
        .log-item { padding: 10px; border-left: 3px solid var(--pink); background: #f8f9fa; margin-bottom: 8px; border-radius: 0 8px 8px 0; font-size: 14px; }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="login-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:white;padding:30px;border-radius:15px;text-align:center;max-width:350px;width:90%;">
            <i class="fas fa-user-shield" style="font-size:50px;color:#e91e8c;margin-bottom:15px;"></i>
            <h5>เข้าสู่ระบบ Admin</h5>
            <p class="text-muted small">โรงพยาบาลราชวิถี</p>
            <input type="password" id="login-password" class="form-control my-3" placeholder="กรอกรหัสผ่าน">
            <button class="btn btn-pink w-100" onclick="checkLogin()"><i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ</button>
            <div id="login-error" class="text-danger mt-2" style="display:none;">รหัสผ่านไม่ถูกต้อง</div>
            <a href="/" class="d-block mt-3 text-muted"><i class="fas fa-arrow-left me-1"></i>กลับหน้าหลัก</a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display:none;">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <h4 class="mb-1"><i class="fas fa-cog me-2"></i>ระบบจัดการ Admin</h4>
                    <small>โรงพยาบาลราชวิถี - Rajavithi AI Wayfinding Platform</small>
                </div>
                <div>
                    <a href="/" class="btn btn-light btn-sm me-2"><i class="fas fa-home me-1"></i>หน้าหลัก</a>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>ออกจากระบบ</button>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Stats -->
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="stat-locations">0</div>
                    <div class="stat-label"><i class="fas fa-map-marker-alt me-1"></i>จุดทั้งหมด</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                    <div class="stat-value" id="stat-buildings">11</div>
                    <div class="stat-label"><i class="fas fa-building me-1"></i>อาคาร</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #fc4a1a, #f7b733);">
                    <div class="stat-value" id="stat-floors">0</div>
                    <div class="stat-label"><i class="fas fa-layer-group me-1"></i>ชั้นที่มีข้อมูล</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #ee0979, #ff6a00);">
                    <div class="stat-value" id="stat-qr">0</div>
                    <div class="stat-label"><i class="fas fa-qrcode me-1"></i>QR ที่สร้าง</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Menu -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header"><i class="fas fa-th-large me-2 text-primary"></i>เมนูจัดการ</div>
                    <div class="card-body">
                        <a href="/map-editor" class="menu-item">
                            <div class="menu-icon" style="background: #e3f2fd; color: #1976d2;"><i class="fas fa-map-marked-alt"></i></div>
                            <div>
                                <div class="fw-bold">Map Editor</div>
                                <small class="text-muted">เพิ่ม/แก้ไข จุดบนแผนที่, อัปโหลด Floor Plan, สร้าง QR Code</small>
                            </div>
                        </a>
                        <a href="/navigate" class="menu-item">
                            <div class="menu-icon" style="background: #e8f5e9; color: #388e3c;"><i class="fas fa-route"></i></div>
                            <div>
                                <div class="fw-bold">ทดสอบนำทาง</div>
                                <small class="text-muted">ทดสอบระบบนำทางด้วย AI</small>
                            </div>
                        </a>
                        <a href="/" class="menu-item">
                            <div class="menu-icon" style="background: #fce4ec; color: #c2185b;"><i class="fas fa-home"></i></div>
                            <div>
                                <div class="fw-bold">หน้าหลัก</div>
                                <small class="text-muted">กลับไปหน้าแรกของระบบ</small>
                            </div>
                        </a>
                        <div class="menu-item" onclick="clearAllData()">
                            <div class="menu-icon" style="background: #ffebee; color: #d32f2f;"><i class="fas fa-trash-alt"></i></div>
                            <div>
                                <div class="fw-bold">ล้างข้อมูลทั้งหมด</div>
                                <small class="text-muted">ลบข้อมูลจุดและ Floor Plan ทั้งหมด (ระวัง!)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header"><i class="fas fa-server me-2 text-success"></i>สถานะระบบ</div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                            <div><i class="fas fa-robot me-2 text-primary"></i>AI System</div>
                            <span class="status-badge" id="ai-status">กำลังตรวจสอบ...</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                            <div><i class="fas fa-database me-2 text-info"></i>Database</div>
                            <span class="status-badge status-online">Online</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                            <div><i class="fas fa-volume-up me-2 text-warning"></i>Text-to-Speech</div>
                            <span class="status-badge status-online">พร้อมใช้งาน</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                            <div><i class="fas fa-location-dot me-2 text-danger"></i>GPS</div>
                            <span class="status-badge" id="gps-status">-</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><i class="fas fa-info-circle me-2 text-info"></i>ข้อมูลอาคาร</div>
                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm small">
                            <thead><tr><th>อาคาร</th><th>จำนวนชั้น</th><th>จุด</th></tr></thead>
                            <tbody id="building-info"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-muted mt-4">
            <small>Hospital Wayfinding System v1.0 | โรงพยาบาลราชวิถี</small>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const BUILDINGS = [
            { code: 'A', name: 'อาคารทศมินทราธิราช', floors: 25 },
            { code: 'B', name: 'ตึกสิรินธร', floors: 18 },
            { code: 'CHALERM', name: 'อาคารเฉลิมพระเกียรติฯ', floors: 14 },
            { code: 'D', name: 'ตึกอำนวยการ', floors: 5 },
            { code: 'E', name: 'ตึกอุบัติเหตุและฉุกเฉิน EMS', floors: 4 },
            { code: 'F', name: 'ตึกอายุรกรรม', floors: 6 },
            { code: 'G', name: 'ตึกสอาด ศิริพัฒน์', floors: 8 },
            { code: 'H', name: 'ตึกหลวงชำนาญเนติศาสตร์', floors: 6 },
            { code: 'I', name: 'ตึกเจริญ พูลวรลักษณ์', floors: 5 },
            { code: 'J', name: 'ตึกวิเคราะห์โรคหัวใจ', floors: 4 },
            { code: 'K', name: 'ตึกวาศอุทิศ', floors: 3 }
        ];

        // Login
        function checkLogin() {
            const pw = document.getElementById('login-password').value;
            fetch('/api/verify-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pw })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    loadStats();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            }).catch(() => {
                if (pw === 'rajavithi2024') {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    loadStats();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            });
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        document.getElementById('login-password').addEventListener('keypress', e => { if (e.key === 'Enter') checkLogin(); });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                loadStats();
            }
        });

        function loadStats() {
            // Load from localStorage
            try {
                const saved = localStorage.getItem('hospitalMapEditor');
                if (saved) {
                    const data = JSON.parse(saved);
                    const locations = data.locations || [];
                    document.getElementById('stat-locations').textContent = locations.length;
                    
                    const floorsWithData = new Set(locations.map(l => `${l.building}_${l.floor}`));
                    document.getElementById('stat-floors').textContent = floorsWithData.size;
                    document.getElementById('stat-qr').textContent = locations.length;

                    // Building info
                    const tbody = document.getElementById('building-info');
                    tbody.innerHTML = BUILDINGS.map(b => {
                        const count = locations.filter(l => l.building === b.code).length;
                        return `<tr><td>${b.name}</td><td>${b.floors}</td><td>${count}</td></tr>`;
                    }).join('');
                }
            } catch (e) { console.error(e); }

            // Check AI status
            fetch('/api/ai/status').then(r => r.json()).then(data => {
                const el = document.getElementById('ai-status');
                if (data.active_provider && data.active_provider !== 'none') {
                    el.className = 'status-badge status-online';
                    el.textContent = `${data.active_provider.toUpperCase()} พร้อม`;
                } else {
                    el.className = 'status-badge status-offline';
                    el.textContent = 'ไม่พร้อม';
                }
            }).catch(() => {
                document.getElementById('ai-status').className = 'status-badge status-offline';
                document.getElementById('ai-status').textContent = 'ไม่พร้อม';
            });

            // Check GPS
            if (navigator.geolocation) {
                document.getElementById('gps-status').className = 'status-badge status-online';
                document.getElementById('gps-status').textContent = 'รองรับ';
            } else {
                document.getElementById('gps-status').className = 'status-badge status-offline';
                document.getElementById('gps-status').textContent = 'ไม่รองรับ';
            }
        }

        function clearAllData() {
            if (confirm('⚠️ คุณต้องการลบข้อมูลทั้งหมด?\n\nการดำเนินการนี้ไม่สามารถยกเลิกได้!')) {
                if (confirm('ยืนยันอีกครั้ง: ลบข้อมูลจุดและ Floor Plan ทั้งหมด?')) {
                    localStorage.removeItem('hospitalMapEditor');
                    alert('✅ ลบข้อมูลทั้งหมดแล้ว');
                    loadStats();
                }
            }
        }
    </script>
</body>
</html>
